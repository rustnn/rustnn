#!/bin/bash
# Pre-commit hook to ensure Rust and Python quality checks run only when needed
#
# To install this hook, run:
#   cp scripts/git-hooks/pre-commit .git/hooks/pre-commit
#   chmod +x .git/hooks/pre-commit
#
# Or use the installation script:
#   ./scripts/install-git-hooks.sh

set -e

REPO_ROOT="$(git rev-parse --show-toplevel)"
cd "$REPO_ROOT"

STAGED_FILES="$(git diff --cached --name-only)"

has_rust_changes() {
    echo "$STAGED_FILES" | grep -E '\.rs$|Cargo\.toml|build\.rs' >/dev/null
}

has_python_changes() {
    echo "$STAGED_FILES" | grep -E '\.py$|\.pyi$' >/dev/null
}

if [ -z "$STAGED_FILES" ]; then
    echo "No staged files; skipping checks."
    exit 0
fi

if has_rust_changes; then
    echo "Running cargo fmt check..."
    cargo fmt --all -- --check

    echo "Running cargo clippy..."
    cargo clippy --all-targets --all-features -- -D warnings
fi

if has_python_changes; then
    echo "Running ty type check (python-ty-check)..."
    make python-ty-check
fi

echo "âœ… Pre-commit checks passed (skipped sections if no relevant changes)."
exit 0
